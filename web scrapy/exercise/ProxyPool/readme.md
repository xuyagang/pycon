[toc]



[参考1](https://github.com/jhao104/proxy_pool), [参考2](https://cuiqingcai.com/7048.html)



### 环境配置
- Redis、Aiohttp、Requests、RedisPy、PyQuery、Flask

### 代理池目标

代理池要易用高效，我们要做到以下目标：

- 基本模块：获取模块，存储模块，检查模块，接口模块
  - ==获取模块==需要定时去各大代理网站抓取代理，代理可以是免费公开代理也可以是付费代理，代理的形式都是 IP 加端口，尽量从不同来源获取，尽量抓取高匿代理，抓取完之后将可用代理保存到数据库中
  - ==存储模块==负责存储抓取下来的代理。首先我们需要保证代理==不重复==，我们还需要标识代理的可用情况，而且需要动态实时处理每个代理，所以说，一种比较高效和方便的存储方式就是使用 Redis 的 ==Sorted Set==，也就是==有序集合==
  - ==检测模块==需要将数据库中的数据进行实时的检测，需要设置一个检测链接，最后爬取哪个网站就爬取哪个网站，这样更有针对性。如果要做一个通用型的代理，可以设置百度等链接来检测，另外我们需要标识每一个代理的状态，如设置分数标识，100分代表可用，分数越少代表越不可用，检测一次如果可用我们就将其设置为100分，在此基础上可用加1，不可用减1，当减到一定阈值后就从数据库移除，这样可以区分出代理可用情况，更有针对性
  - ==接口模块==需要用 API 来提供对外服务的接口，其实我们可以直接连数据库来取，但是这样就需要知道数据库的连接信息，不太安全，而且需要配置连接，所以一个比较安全和方便的方式就是提供一个 ==Web API==接口，通过访问接口即可拿到可用代理。另外由于可用代理可能有多个，我们可以提供==随机返回==一个可用代理的接口，这样保证每个可用代理都可以取到，实现==负载均衡==

### 代理池的架构

![018](D:\project\pycon\web scrapy\img\018.png)

代理池分为四个部分，获取模块、存储模块、检测模块、接口模块。

- 存储模块使用Redis的有序集合，用以代理的去重和状态标识，同时它也是中心模块和基础模块，将其他模块串联起来。
- 获取模块定时从代理网站获取代理，将获取的代理传递给存储模块，保存到数据库。
- 检测模块定时通过存储模块获取所有代理，并对其进行检测，根据不同的检测结果对代理设置不同的标识。
- 接口模块通过 Web API 提供服务接口，其内部还是连接存储模块，获取可用的代理。

### 代理池的实现

#### 存储模块

存储在这里我们使用 Redis 的有序集合，集合的每一个元素都是不重复的，对于代理代理池来说，集合的元素就变成了一个个代理，也就是 IP 加端口的形式，如 60.207.237.111:8888，这样的一个代理就是集合的一个元素。另外有序集合的每一个元素还都有一个分数字段，分数是可以重复的，是一个浮点数类型，也可以是整数类型。该集合会根据每一个元素的分数对集合进行排序，数值小的排在前面，数值大的排在后面，这样就可以实现集合元素的排序了

我们设置分数规则如下：

- 分数 100 为可用，检测器会定时循环检测每个代理可用情况，==一旦检测到有可用的代理就立即置为 100==，检测到==不可用就将分数减 1==，减至 0 后移除。
- ==新获取的代理添加时将分数置为 10==，当测试==可行立即置 100==，不可行分数减 1，减至 0 后移除。

这是一种解决方案，当然可能还有更合理的方案。此方案的设置有一定的原因，在此总结如下：

- 当检测到代理可用时立即置为 100，这样可以保证所有可用代理有更大的机会被获取到。你可能会说为什么不直接将分数加 1 而是直接设为最高 100 呢？设想一下，我们有的代理是从各大免费公开代理网站获取的，如果一个代理并没有那么稳定，平均五次请求有两次成功，三次失败，如果按照这种方式来设置分数，那么这个代理几乎不可能达到一个高的分数，也就是说它有时是可用的，但是我们筛选是筛选的分数最高的，所以这样的代理就几乎不可能被取到，当然如果想追求代理稳定性的化可以用这种方法，这样可确保分数最高的一定是最稳定可用的。但是在这里我们采取可用即设置 100 的方法，确保只要可用的代理都可以被使用到。
- 当检测到代理不可用时，将分数减 1，减至 0 后移除，一共 100 次机会，也就是说当一个可用代理接下来如果尝试了 100 次都失败了，就一直减分直到移除，一旦成功就重新置回 100，尝试机会越多代表将这个代理拯救回来的机会越多，这样不容易将曾经的一个可用代理丢弃，因为代理不可用的原因可能是网络繁忙或者其他人用此代理请求太过频繁，所以在这里设置为 100 级。
- 新获取的代理分数设置为 10，检测如果不可用就减 1，减到 0 就移除，如果可用就置 100。由于我们很多代理是从免费网站获取的，所以新获取的代理无效的可能性是非常高的，可能不足 10%，所以在这里我们将其设置为 10，检测的机会没有可用代理 100 次那么多，这也可以适当减少开销































